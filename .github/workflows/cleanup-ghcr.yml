name: Cleanup GHCR Images

on:
  schedule:
    # Run daily at 2 AM UTC
    - cron: '0 2 * * *'
  workflow_dispatch:

# NOTE: The `*` and `!` filter operators in image-tags/image-names only work
# with a PAT or GitHub App token. If using GITHUB_TOKEN, you must use exact
# names and cannot use wildcard/exclusion filters. To use filters, create a PAT
# with `packages:write` scope and store it as a repository secret (e.g., PAT).
# Then replace `${{ secrets.GITHUB_TOKEN }}` with `${{ secrets.PAT }}` below.

jobs:
  cleanup:
    name: Cleanup Old Container Images
    runs-on: ubuntu-latest
    permissions:
      packages: write
      contents: read

    steps:
      - name: Cleanup untagged images
        uses: snok/container-retention-policy@v3.0.1
        with:
          image-names: gyre
          cut-off: 7d
          account: user
          token: ${{ secrets.GITHUB_TOKEN }}
          tag-selection: untagged
          timestamp-to-use: created_at

      - name: Cleanup old PR images
        uses: snok/container-retention-policy@v3.0.1
        with:
          image-names: gyre
          cut-off: 7d
          account: user
          token: ${{ secrets.PAT }}
          image-tags: "pr-*"
          tag-selection: tagged
          keep-n-most-recent: 5
          timestamp-to-use: created_at

      - name: Cleanup old branch images
        uses: snok/container-retention-policy@v3.0.1
        with:
          image-names: gyre
          cut-off: 4w
          account: user
          token: ${{ secrets.PAT }}
          image-tags: "feat/* fix/* chore/* docs/* refactor/* ci/*"
          tag-selection: tagged
          timestamp-to-use: created_at

      - name: Cleanup old SHA-tagged releases
        uses: snok/container-retention-policy@v3.0.1
        with:
          image-names: gyre
          cut-off: 14d
          account: user
          token: ${{ secrets.PAT }}
          image-tags: "v*-*"
          tag-selection: tagged
          keep-n-most-recent: 3
          timestamp-to-use: created_at

      - name: Cleanup summary
        if: always()
        run: |
          echo "## ðŸ§¹ GHCR Cleanup Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Retention Policy Applied" >> $GITHUB_STEP_SUMMARY
          echo "| Type | Retention Period | Notes |" >> $GITHUB_STEP_SUMMARY
          echo "|------|------------------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| **Untagged images** | 7 days | Automatically removed |" >> $GITHUB_STEP_SUMMARY
          echo "| **PR tags** (\`pr-*\`) | 7 days | Keep 5 most recent |" >> $GITHUB_STEP_SUMMARY
          echo "| **Branch tags** (\`feat/* fix/*\` etc.) | 4 weeks | Feature branch images |" >> $GITHUB_STEP_SUMMARY
          echo "| **SHA-tagged releases** (\`v*-*\`) | 14 days | Keep 3 most recent |" >> $GITHUB_STEP_SUMMARY
          echo "| **Release tags** (\`v*.*.*\`) | Forever | Not matched by cleanup rules |" >> $GITHUB_STEP_SUMMARY
          echo "| **latest / main / develop** | Forever | Not matched by cleanup rules |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Protected Tags (not targeted by any cleanup step)" >> $GITHUB_STEP_SUMMARY
          echo "- \`latest\` â€” only applied on main branch pushes" >> $GITHUB_STEP_SUMMARY
          echo "- \`main\` â€” branch ref tag" >> $GITHUB_STEP_SUMMARY
          echo "- \`develop\` â€” branch ref tag" >> $GITHUB_STEP_SUMMARY
          echo "- \`v*.*.*\` â€” semver release tags (e.g. \`v1.0.0\`)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Cleanup completed at $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
